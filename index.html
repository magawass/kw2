<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magawa Secondary | Official Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: "#1a2a6c", secondary: "#fdbb2d", accent: "#20B2AA" }
                }
            }
        }

        const GITHUB_CONFIG = { owner: "magawass", repo: "kw2", path: "data/content.json" };
        let adminContent = {
            headerTitle: "Quality Education",
            headerSub: "     ",
            headerImg: "",
            announcements: "",
            aboutText: "",
            upcoming: "",
            adverts: [], 
            noticeBoard: [], 
            mediaGallery: [] 
        };

        function showPage(pageId) {
            document.getElementById('mainNav').style.display = 'block';
            document.getElementById('mainFooter').style.display = 'block';
            const pages = document.querySelectorAll('.page');
            pages.forEach(p => p.classList.remove('active'));
            const target = document.getElementById(pageId);
            if (target) target.classList.add('active');
            window.scrollTo(0,0);
        }

        function openPortal() {
            document.getElementById('mainNav').style.display = 'none';
            document.getElementById('mainFooter').style.display = 'none';
            const pages = document.querySelectorAll('.page');
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById('portalContainer').classList.add('active');
        }

        function setSyncStatus(msg, isError = false) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.innerText = msg;
            statusEl.className = isError ? "text-red-500 font-bold ml-4 text-xs" : "text-green-500 font-bold ml-4 text-xs";
        }

        async function loadContent() {
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    const decoded = decodeURIComponent(escape(atob(data.content)));
                    adminContent = JSON.parse(decoded);
                    if(!Array.isArray(adminContent.adverts)) adminContent.adverts = [];
                    if(!Array.isArray(adminContent.noticeBoard)) adminContent.noticeBoard = [];
                    if(!Array.isArray(adminContent.mediaGallery)) adminContent.mediaGallery = [];
                    updateDisplayContent();
                    renderAdminLists();
                }
            } catch (error) {
                adminContent = JSON.parse(localStorage.getItem('magawaAdminContent')) || adminContent;
                updateDisplayContent();
                renderAdminLists();
            }
        }

        function updateDisplayContent() {
            document.getElementById('displayHeaderTitle').innerText = adminContent.headerTitle || "Success Guaranteed";
            document.getElementById('displayHeaderSub').innerHTML = adminContent.headerSub || "Education for ALL";
            const hImg = document.getElementById('displayHeader');
            if(adminContent.headerImg) {
                hImg.src = adminContent.headerImg;
                hImg.classList.remove('hidden');
            }

            document.getElementById('displayAnnouncement').innerText = adminContent.announcements || "";
            document.getElementById('displayAboutText').innerText = adminContent.aboutText || "";
            document.getElementById('displayUpcoming').innerText = adminContent.upcoming || "";

            // Populate admin inputs to match current content
            if(document.getElementById('adminHeaderTitle')) {
                document.getElementById('adminHeaderTitle').value = adminContent.headerTitle || "";
                document.getElementById('adminHeaderSub').value = adminContent.headerSub || "";
                document.getElementById('adminAnnounceInput').value = adminContent.announcements || "";
                document.getElementById('adminAboutInput').value = adminContent.aboutText || "";
                document.getElementById('adminUpcomingInput').value = adminContent.upcoming || "";
            }
            
            const renderGrid = (items, type) => items.map(item => `
                <div class="mb-4 border-b pb-2">
                    ${(item.image || item.file) ? `<img src="${item.image || item.file}" class="w-full rounded mb-1">` : ''}
                    <p class="${type === 'mediaGallery' ? 'text-xs text-center italic' : 'text-sm italic'}">${item.text || item.caption || ''}</p>
                </div>
            `).join('');

            document.getElementById('displayAdverts').innerHTML = renderGrid(adminContent.adverts, 'adverts');
            document.getElementById('displayNoticeBoard').innerHTML = renderGrid(adminContent.noticeBoard, 'noticeBoard');
            document.getElementById('galleryDisplay').innerHTML = renderGrid(adminContent.mediaGallery, 'mediaGallery');
        }

        function resizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        let scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }

        function deleteItem(type, index) {
            if(confirm("Delete this item?")) {
                adminContent[type].splice(index, 1);
                renderAdminLists();
                setSyncStatus("Item removed. Remember to SAVE CHANGES to update the live site.");
            }
        }

        function renderAdminLists() {
            const sections = [
                { id: 'adminAdList', type: 'adverts' },
                { id: 'adminNoticeList', type: 'noticeBoard' },
                { id: 'adminGalleryList', type: 'mediaGallery' }
            ];
            
            sections.forEach(sec => {
                const container = document.getElementById(sec.id);
                container.innerHTML = adminContent[sec.type].map((item, idx) => `
                    <div class="flex items-center justify-between bg-gray-100 p-2 rounded mb-2 border shadow-sm">
                        <div class="flex items-center space-x-2 overflow-hidden">
                            ${(item.image || item.file) ? `<img src="${item.image || item.file}" class="h-8 w-8 object-cover rounded">` : '<i class="fas fa-file-alt text-gray-400"></i>'}
                            <span class="text-[10px] truncate font-bold uppercase">${item.text || item.caption || 'No Title'}</span>
                        </div>
                        <button onclick="deleteItem('${sec.type}', ${idx})" class="text-red-600 hover:text-red-800 p-1">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('');
            });
        }

        async function addItem(type) {
            const textInput = document.getElementById(`input${type}Text`);
            const fileInput = document.getElementById(`input${type}File`);
            const btn = document.querySelector(`button[onclick="addItem('${type}')"]`);
            
            if (!textInput.value && !fileInput.files[0]) return;

            btn.disabled = true;
            btn.innerHTML = "Processing...";

            let imageData = "";
            if (fileInput.files[0]) {
                imageData = await resizeImage(fileInput.files[0]);
            }

            const newItem = {
                text: type !== 'mediaGallery' ? textInput.value : "",
                caption: type === 'mediaGallery' ? textInput.value : "",
                image: type !== 'mediaGallery' ? imageData : undefined,
                file: type === 'mediaGallery' ? imageData : undefined
            };

            adminContent[type].push(newItem);
            textInput.value = "";
            fileInput.value = "";
            btn.disabled = false;
            btn.innerHTML = "ADD ITEM";
            renderAdminLists();
            setSyncStatus("Item added to local list.");
        }

        async function saveAdminContent() {
            const token = document.getElementById('ghTokenInput').value.trim();
            if (!token) { setSyncStatus("Error: No Token", true); return; }

            const btn = document.getElementById('saveBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>SYNCING TO GITHUB...';
            btn.disabled = true;

            try {
                adminContent.headerTitle = document.getElementById('adminHeaderTitle').value;
                adminContent.headerSub = document.getElementById('adminHeaderSub').value;
                const hImgFile = document.getElementById('adminHeaderFile').files[0];
                if(hImgFile) adminContent.headerImg = await resizeImage(hImgFile);

                adminContent.announcements = document.getElementById('adminAnnounceInput').value;
                adminContent.aboutText = document.getElementById('adminAboutInput').value;
                adminContent.upcoming = document.getElementById('adminUpcomingInput').value;

                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
                let sha = "";
                const checkRes = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                if (checkRes.ok) { const d = await checkRes.json(); sha = d.sha; }

                const finalJson = JSON.stringify(adminContent);
                const base64Content = btoa(unescape(encodeURIComponent(finalJson)));

                const syncRes = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "Update Magawa Content", content: base64Content, sha: sha })
                });

                if (syncRes.ok) {
                    setSyncStatus("✅ SUCCESSFULLY SAVED!");
                    localStorage.setItem('magawaAdminContent', finalJson);
                    updateDisplayContent();
                } else {
                    const errData = await syncRes.json();
                    setSyncStatus(`❌ FAILED: ${errData.message}`, true);
                }
            } catch (err) {
                setSyncStatus(`❌ ERROR: ${err.message}`, true);
            } finally {
                btn.innerHTML = '<i class="fas fa-save mr-2"></i>SAVE CHANGES TO REPOSITORY';
                btn.disabled = false;
            }
        }

        function authenticateAdmin() {
            if (document.getElementById('adminPass').value === 'admin123') {
                showPage('adminPanel');
                updateDisplayContent();
            }
            else alert('Invalid Password');
        }

        document.addEventListener('DOMContentLoaded', loadContent);
    </script>
    
    <style>
        .page { display: none; }
        .page.active { display: block; }
        #portalContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: white; z-index: 1000; }
        iframe { width: 100%; height: calc(100vh - 60px); border: none; }
        .admin-input { border: 1px solid #ddd; padding: 10px; border-radius: 8px; font-size: 13px; width: 100%; margin-bottom: 10px; }
        .section-box { background: #fdfdfd; padding: 15px; border-radius: 12px; border: 1px solid #eaeaea; margin-bottom: 20px; }
        .label-text { font-size: 10px; font-weight: 900; color: #1a2a6c; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: block; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <nav id="mainNav" class="bg-primary text-white sticky top-0 z-50 p-3 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
            <span class="font-bold text-lg">KAWALE PRIVATE SECONDARY</span>
            </div>
            <div class="hidden md:flex space-x-6 text-xs font-bold uppercase">
                <button onclick="showPage('homePage')">Home</button>
                <button onclick="openPortal()" class="bg-secondary text-primary px-3 py-1 rounded">Portal</button>
                <button onclick="showPage('adminLogin')">Admin</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-8">
        <div id="homePage" class="page active space-y-10">
            <div class="bg-primary rounded-3xl p-10 text-white flex justify-between items-center">
                <div class="w-2/3">
                    <div class="flex items-center space-x-4 mb-1">
                        <h2 id="displayHeaderTitle" class="text-3xl font-black uppercase">Success Guaranteed</h2>
                        <img id="displayHeaderImg" src="" class="h-12 w-12 object-cover rounded-full hidden border-2 border-secondary">
                    </div>
                    <p id="displayHeaderSub" class="mb-4 font-bold italic">
                        <span class="text-white">Success,</span> 
                        <span class="text-secondary">Guaranteed</span>
                    </p>
                    <p id="displayAboutText" class="opacity-90 mb-6"></p>
                    <button onclick="openPortal()" class="bg-white text-primary px-6 py-2 rounded-lg font-bold">Exam Portal</button>
                </div>
                <i class="fas fa-graduation-cap text-[100px] opacity-30"></i>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-primary">
                    <h3 class="font-bold mb-3 uppercase text-xs tracking-widest">Announcements</h3>
                    <p id="displayAnnouncement" class="text-sm"></p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-accent">
                    <h3 class="font-bold mb-3 uppercase text-xs tracking-widest text-accent">Gallery</h3>
                    <div id="galleryDisplay" class="space-y-4"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-secondary">
                    <h3 class="font-bold mb-3 uppercase text-xs tracking-widest">Upcoming</h3>
                    <p id="displayUpcoming" class="text-sm"></p>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl border-t-4 border-green-500">
                    <h3 class="font-bold mb-3 text-green-600 uppercase text-xs tracking-widest">Adverts</h3>
                    <div id="displayAdverts"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl border-t-4 border-orange-500">
                    <h3 class="font-bold mb-3 text-orange-600 uppercase text-xs tracking-widest">Notice Board</h3>
                    <div id="displayNoticeBoard"></div>
                </div>
            </div>
        </div>

        <div id="adminLogin" class="page max-w-md mx-auto py-20 text-center">
            <div class="bg-white p-8 rounded-3xl shadow-lg border">
                <h2 class="text-xl font-bold mb-6 text-primary">ADMIN LOGIN</h2>
                <input type="password" id="adminPass" placeholder="Password" class="admin-input text-center">
                <button onclick="authenticateAdmin()" class="w-full bg-primary text-white py-3 rounded-xl font-bold mt-2">LOG IN</button>
            </div>
        </div>

        <div id="adminPanel" class="page max-w-5xl mx-auto py-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-black text-primary uppercase">Repo Manager</h2>
                <span id="syncStatus" class="text-xs font-bold text-gray-400 italic">Ready</span>
                <button onclick="showPage('homePage')" class="text-xs font-bold text-gray-500 underline uppercase">Exit</button>
            </div>

            <div class="bg-white p-4 rounded-xl border-2 border-primary/10 mb-6">
                <label class="label-text">Authentication Token</label>
                <input type="password" id="ghTokenInput" placeholder="GitHub Access Token" class="admin-input border-dashed border-2">
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div class="section-box">
                        <label class="label-text">0. Main Header Settings</label>
                        <input type="text" id="adminHeaderTitle" class="admin-input" placeholder="Main Title (e.g. Education for ALL)">
                        <textarea id="adminHeaderSub" class="admin-input h-12" placeholder="Sub-statement (use <span> tags for colors)"></textarea>
                        <label class="text-[10px] text-gray-400">Header Icon/Image:</label>
                        <input type="file" id="adminHeaderFile" class="text-[10px] mb-2 block w-full">

                        <label class="label-text">1. About Us Text</label>
                        <textarea id="adminAboutInput" class="admin-input h-20" placeholder="About the school..."></textarea>
                        
                        <label class="label-text">2. Main Announcement</label>
                        <textarea id="adminAnnounceInput" class="admin-input" placeholder="Current notices..."></textarea>
                        
                        <label class="label-text">3. Upcoming Events</label>
                        <textarea id="adminUpcomingInput" class="admin-input" placeholder="Term dates, etc..."></textarea>
                    </div>

                    <button id="saveBtn" onclick="saveAdminContent()" class="w-full bg-primary text-white py-5 rounded-2xl font-black shadow-xl uppercase tracking-widest hover:scale-[1.01] transition-all">
                        <i class="fas fa-save mr-2"></i>SAVE ALL CHANGES
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="section-box">
                        <label class="label-text">4. Adverts Management</label>
                        <div id="adminAdList" class="max-h-32 overflow-y-auto mb-4"></div>
                        <input type="file" id="inputadvertsFile" class="text-[10px] mb-2 block w-full">
                        <input type="text" id="inputadvertsText" class="admin-input" placeholder="Advert Caption">
                        <button onclick="addItem('adverts')" class="w-full bg-green-600 text-white py-2 rounded font-bold text-[10px] uppercase">Add Advert</button>
                    </div>

                    <div class="section-box">
                        <label class="label-text">5. Notice Board Management</label>
                        <div id="adminNoticeList" class="max-h-32 overflow-y-auto mb-4"></div>
                        <input type="file" id="inputnoticeBoardFile" class="text-[10px] mb-2 block w-full">
                        <input type="text" id="inputnoticeBoardText" class="admin-input" placeholder="Notice Text">
                        <button onclick="addItem('noticeBoard')" class="w-full bg-orange-600 text-white py-2 rounded font-bold text-[10px] uppercase">Add Notice</button>
                    </div>

                    <div class="section-box">
                        <label class="label-text">6. Gallery Management</label>
                        <div id="adminGalleryList" class="max-h-32 overflow-y-auto mb-4"></div>
                        <input type="file" id="inputmediaGalleryFile" class="text-[10px] mb-2 block w-full">
                        <input type="text" id="inputmediaGalleryText" class="admin-input" placeholder="Gallery Caption">
                        <button onclick="addItem('mediaGallery')" class="w-full bg-accent text-white py-2 rounded font-bold text-[10px] uppercase">Add Image</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="portalContainer" class="page">
            <div class="bg-white p-3 border-b flex justify-between items-center">
                <button onclick="showPage('homePage')" class="text-primary font-bold px-4">EXIT</button>
                <div class="text-xs font-black tracking-widest">    </div>
                <div class="w-10"></div>
            </div>
            <iframe src="brief22_BUTTONS_FIXED.html"></iframe>
        </div>
    </main>

    <footer id="mainFooter" class="py-10 text-center text-[10px] text-gray-400 uppercase tracking-widest border-t mt-10">
        © 2025 Kawale Private Secondary School.Designed by Chiku Lubaini(099 40 39 325).All rights reserved.
    </footer>

</body>
</html>
