<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magawa Secondary Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* Global Reset and Box Sizing */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* Body - Full view height, professional background */
    body {
        background: #e9ebee;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
    }

    /* --- NEW Loading Indicator Styles --- */
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s;
    }

    #loadingSpinner {
        text-align: center;
        padding: 30px;
        border-radius: 15px;
        background: #ffffff;
        box-shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
        min-width: 200px;
    }

    #loadingCircle {
        width: 70px;
        height: 70px;
        border: 8px solid #f0f0f0;
        border-top: 8px solid #17a2b8;
        border-radius: 50%;
        animation: spin 1.2s cubic-bezier(0.5, 0.2, 0.5, 0.5) infinite;
        margin: 0 auto 15px auto;
    }

    #loadingText {
        font-size: 1.1em;
        color: #2c3e50;
        font-weight: 600;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Page Container */
    .page {
        display: none;
        width: 95%;
        max-width: 650px;
        padding: 30px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        margin: 20px 0;
        text-align: center;
    }

    #initialPage { display: block; text-align: center; }

    /* Header/Logo */
    .logo { max-width: 150px; height: auto; margin-bottom: 10px; }
    h1, h2 { color: #34495e; margin: 5px 0; font-weight: 600; }
    h1 p { font-size: 24px; margin: 0; }
    h2 { font-size: 1.2em; color: #7f8c8d; }

    /* Forms/Inputs */
    label {
        display: block;
        margin-top: 15px;
        font-weight: 500;
        color: #2c3e50;
        text-align: center;
    }

    select, input:not([type="file"]):not([type="password"]), textarea {
        width: 100%;
        max-width: 400px;
        padding: 12px;
        margin-top: 5px;
        border-radius: 8px;
        border: 1px solid #cc6600;
        background-color: #98FB9;
        color: #333;
        font-size: 1em;
        transition: border-color 0.3s;
        font-family: inherit;
        text-align: center;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    input[type="file"] {
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        padding: 10px;
        margin-top: 10px;
        display: block;
        border: 1px solid #cc6600;
        border-radius: 8px;
    }

    select:focus, input:focus, textarea:focus {
        border-color: #cc6600;
        outline: none;
    }

    textarea {
        resize: vertical;
    }

    /* Buttons */
    button {
        width: 100%;
        max-width: 400px;
        margin-top: 20px;
        padding: 14px;
        background: #20B2AA;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 600;
        transition: background 0.3s, transform 0.1s;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    .small-btn {
        width: auto !important;
        max-width: 200px !important;
        margin-left: 10px;
        margin-right: 10px;
        display: inline-block;
    }

    button:hover { background: #148f9e; }
    button:active { transform: scale(0.99); }

    /* Tables */
    #progressReport #resultsTable,
    #gradesTable,
    #analysisTable,
    #scoresTable,
    #briefResultsTable {
        min-width: 500px;
        border-collapse: collapse;
        font-size: 0.9em;
        width: 100%;
        border: 1px solid black;
    }

    .table-wrapper {
        overflow-x: auto;
        width: 100%;
        margin-top: 15px;
        text-align: left;
    }

    /* Table Cell Styles */
    #resultsTable th, #resultsTable td,
    #gradesTable th, #gradesTable td,
    #analysisTable th, #analysisTable td,
    #scoresTable th, #scoresTable td,
    #briefResultsTable th, #briefResultsTable td {
        border: 1px solid black;
        padding: 10px 8px;
    }

    #resultsTable th, #gradesTable th, #analysisTable th, #scoresTable th, #briefResultsTable th {
        background: #ecf0f1;
        color: #2c3e50;
        font-weight: 600;
        text-align: center;
    }

    #resultsTable td:first-child, #gradesTable td:first-child, #scoresTable td:nth-child(2), #briefResultsTable td:first-child { text-align: left; }
    #resultsTable td:not(:first-child), #gradesTable td:not(:first-child), #scoresTable td:not(:nth-child(2)), #briefResultsTable td:not(:first-child) { text-align: center; }
    #analysisTable td { text-align: center; }

    /* Progress Report Layout */
    #progressReport #reportHeader {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }

    #reportHeaderRight {
        text-align: right;
        font-size: 0.8em;
        line-height: 1.4;
    }

    #reportHeaderRight h3 {
        font-size: 1.3em;
        margin: 0 0 5px 0;
        color: black;
    }

    #progressReport, #briefReport {
        background-color: white;
        color: black;
        padding: 40px 20px;
        width: 95%;
        max-width: 650px;
        min-height: auto;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        margin: 20px auto;
    }

    #reportDetails div { color: black; }

    #summaryAndKeyWrapper {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        width: 100%;
        text-align: left;
    }

    #reportSummary {
        width: 48%;
        text-align: left;
    }

    #gradeKeyPlaceholder {
        width: 48%;
        text-align: right;
    }

    #gradeKeyTableNew {
        margin-top: 5px;
        width: 100%;
        border-collapse: collapse;
        font-size: 7.5pt;
        border: 1px solid black;
    }

    #gradeKeyTableNew th, #gradeKeyTableNew td {
        border: 1px solid black;
        padding: 2px 4px;
        text-align: center;
        background-color: white;
        vertical-align: middle;
        color: black;
    }

    .hidden { display: none !important; }

    /* Mobile Adjustments */
    @media (max-width: 480px) {
        .info-row { flex-direction: column; }
        .info-row p { width: 100%; text-align: left !important; }
        .actions { flex-direction: column; gap: 15px; }
        .actions button { width: 100%; }
        #summaryAndKeyWrapper { flex-direction: column; }
        #reportSummary, #gradeKeyPlaceholder { width: 100% !important; margin-bottom: 15px; }
        #gradeKeyPlaceholder { text-align: left; }
        .teacher-input-group { flex-direction: column; align-items: stretch; }
        .teacher-input-group label { flex-basis: auto; text-align: center !important; }
        .teacher-input-group input[type="text"] { flex-basis: auto; text-align: center !important; }
    }

    /* Desktop Table Adjustments */
    @media (min-width: 768px) {
        #scoreSheetView,
        #gradesPage,
        #analysisPage {
            max-width: 1200px !important;
            width: 90% !important;
        }

        #scoreSheetView .table-wrapper,
        #gradesPage .table-wrapper,
        #analysisPage .table-wrapper {
            overflow-x: visible !important;
        }

        #gradesTable,
        #analysisTable,
        #scoresTable {
            min-width: 100% !important;
            width: 100% !important;
            table-layout: auto !important;
        }
    }

    /* Stacked student info */
    #reportDetails p, #briefReportDetails p {
        margin: 0 0 4px 0 !important;
        padding: 0;
        text-align: left !important;
        font-size: 11pt;
        color: black;
    }

    /* Force progress sheet to fit on ONE A4 page */
    #progressReport {
        padding: 20px 20px !important;
        max-height: 1123px !important;
        overflow: hidden !important;
    }

    /* Make table compact */
    #resultsTable th,
    #resultsTable td {
        padding: 4px 3px !important;
        font-size: 9pt !important;
    }

    /* Reduce fonts for summary and key */
    #summaryAndKeyWrapper, #reportSummary, #gradeKeyPlaceholder {
        font-size: 9pt !important;
    }

    #gradeKeyTableNew td, #gradeKeyTableNew th {
        padding: 2px !important;
        font-size: 7.5pt !important;
    }

    /* A4 Printing Styles */
    @media print {
        body * { visibility: hidden; }
        #progressReport[style*="block"],
        #briefReport[style*="block"] {
            visibility: visible !important;
            position: absolute !important;
            left: 0;
            top: 0;
            display: block !important;
            width: auto !important;
            max-width: none !important;
            min-height: auto !important;
            margin: 0 !important;
            box-shadow: none !important;
            font-size: 10pt;
            page-break-after: avoid !important;
            page-break-before: avoid !important;
        }

        #progressReport[style*="block"] *,
        #briefReport[style*="block"] *,
        #progressReport[style*="block"] .table-wrapper,
        #briefReport[style*="block"] .table-wrapper,
        #progressReport[style*="block"] table,
        #briefReport[style*="block"] table,
        #progressReport[style*="block"] thead,
        #briefReport[style*="block"] thead,
        #progressReport[style*="block"] tbody,
        #briefReport[style*="block"] tbody,
        #progressReport[style*="block"] tr,
        #briefReport[style*="block"] tr,
        #progressReport[style*="block"] td,
        #briefReport[style*="block"] td,
        #progressReport[style*="block"] th,
        #briefReport[style*="block"] th {
            visibility: visible !important;
        }

        .back-btn, .view-btn,
        .page[style*="block"] button,
        .page[style*="block"] select,
        .page[style*="block"] label,
        .page[style*="block"] input,
        .page[style*="block"] textarea {
            display: none !important;
        }

        @page { size: A4 portrait; margin: 0.5cm; }

        #progressReport, #briefReport {
            padding: 15px !important;
            position: relative;
            max-height: 1123px !important;
            overflow: hidden !important;
        }

        #resultsTable th, #resultsTable td,
        #briefResultsTable th, #briefResultsTable td {
            padding: 3px 2px !important;
            font-size: 8pt !important;
        }

        #reportDetails p, #briefReportDetails p {
            margin-bottom: 2px !important;
            font-size: 10pt !important;
        }
    }

    @media (min-width: 795px) {
        #progressReport, #briefReport {
            padding: 40px 40px 40px 40px;
            width: 794px;
            max-width: 794px;
            min-height: auto !important;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #progressReport #reportHeader .logo, #briefReport #briefReportHeader .logo { width: 200px; height: 100px; }
        #reportHeaderRight, #briefReportHeaderRight { font-size: 9pt; }
        #reportHeaderRight h3, #briefReportHeaderRight h3 { font-size: 16pt; }
    }
  </style>
</head>
<body>
<div id="loadingOverlay" style="display: none; opacity: 0; visibility: hidden;">
    <div id="loadingSpinner">
        <div id="loadingCircle"></div>
        <div id="loadingText">Loading Results... <span id="loadingPercent">0%</span></div>
    </div>
</div>

<div id="initialPage" class="page">
     <img src="https://raw.githubusercontent.com/kawalepvt/kw/main/logo.png" alt="School Logo" class="logo">
    <h1><p style="font-size:28px;">KAWALE PVT SECONDARY SCHOOL</p></h1>
    <h2>EXAM PORTAL</h2>
    <label for="selectedForm">Select Class/Form</label>
    <select id="selectedForm">
      <option value="">-- Select Class --</option>
      <option value="form1">Form 1</option>
      <option value="form2">Form 2</option>
      <option value="form3">Form 3</option>
      <option value="form4">Form 4</option>
    </select>
    <label for="studentNumberInput">Enter Exam Number</label>
    <input type="text" id="studentNumberInput" placeholder=" ">
    <label for="dobInput">Enter Date of Birth</label>
    <input type="date" id="dobInput">

    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
        <button onclick="loadResults(true)" style="width: 195px; max-width: 195px; margin-top: 0;">View Full Results</button>
        <button onclick="loadBriefResults()" style="width: 195px; max-width: 195px; margin-top: 0;">View Brief Results</button>
    </div>

    <button onclick="openAdminLogin()">LOGIN</button>
    <p style="font-size:11px; margin-top: 15px; color: #7f8c8d;">For Kawale Pvt Secondary School. Designed by Chiku Lubaini (0 994 039 325). All rights reserved.</p>
</div>

<div id="briefReport" class="page">
    <button class="back-btn" onclick="handleBriefBack()" style="position: absolute; top: 10px; left: 10px; width: auto; padding: 5px 10px; max-width: none !important; margin: 0;">Back</button>

    <header id="briefReportHeader" style="width: 100%;">
       <img src="https://raw.githubusercontent.com/kawalepvt/kw/main/logo.png" class="logo" alt="School Logo">     
       <div id="briefReportHeaderRight">
            <h3>KAWALE PVT SECONDARY SCHOOL</h3>
            Private Bag 189,<br>
            LILONGWE.<br>
          
        </div>
    </header>

    <hr style="border-top: 2px solid black; margin: 10px 0;">
    <h2 style="margin: 0; color: black; font-size: 1.2em;"><strong>BRIEF RESULTS</strong></h2>

    <div id="briefReportDetails" style="margin-top: 15px; text-align: left;">
        <p><strong>STUDENT NAME:</strong> <span id="briefReportStudentName"></span></p>
        <p><strong>CLASS:</strong> <span id="briefReportForm"></span></p>
        <p><strong>EXAM NO:</strong> <span id="briefReportExamNo"></span></p>
        <p><strong>TERM:</strong> <span id="briefReportTerm"></span></p>
    </div>

    <div class="table-wrapper" style="margin-top: 10px;">
        <table id="briefResultsTable" style="min-width: 300px; border-collapse: collapse; font-size: 0.9em; width: 100%; border: 1px solid black;">
            <thead>
                <tr>
                    <th style="width: 50%;">SUBJECT</th>
                    <th style="width: 25%;">SCORE</th>
                    <th style="width: 25%;">GRADE</th>
                </tr>
            </thead>
            <tbody id="briefReportBody">
            </tbody>
        </table>
    </div>

    <div id="briefReportSummary" style="margin-top: 15px; text-align: left;">
        <div id="briefAverageLine" class="hidden">Average:<strong> <span id="briefReportAverage"></span></strong></div>
        <div id="briefAggregateLine" class="hidden">Aggregate:<strong> <span id="briefReportAggregate"></span></strong></div>
        <div>Position in Class:<strong> <span id="briefReportPosition"></span></strong></div>
        <div>Remark:<strong> <span id="briefReportOverallRemark"></span></strong></div>
    </div>

    <div style="text-align: right; margin-top: 20px;">
        <button class="view-btn small-btn" onclick="window.print()" style="background: #17a2b8; color: white;">Print Brief Report</button>
    </div>
    <p style="text-align: center; font-size: 8pt; margin-top: 10px; color: #7f8c8d;">This report is a brief overview and is not official.</p>
</div>

<div id="progressReport" class="page">
    <button class="back-btn" onclick="handleProgressBack()" style="position: absolute; top: 10px; left: 10px; width: auto; padding: 5px 10px; max-width: none !important; margin: 0;">Back</button>

    <header id="reportHeader" style="width: 100%;">
	<img src="https://raw.githubusercontent.com/kawalepvt/kw/main/logo.png" class="logo" alt="School Logo">    
        <div id="reportHeaderRight">
            <h3>KAWALE PVT SECONDARY SCHOOL</h3>
            Private Bag 189,<br>
            Lilongwe.<br>
            
        </div>
    </header>

    <hr style="border-top: 2px solid black; margin: 10px 0;">
    <div class="align-left">
      <p style="font-size: 10px;"> <h2 style="margin: 0;color: black;"><strong>PROGRESS REPORT</strong></h2>
    </div>

    <div id="reportDetails">
        <div class="info-row">
            <p><strong>STUDENT NAME:</strong> <span id="reportStudentName"></span></p>
            <p><strong>CLASS:</strong> <span id="reportForm"></span></p>
        </div>
        <div class="info-row">
            <p><strong>Exam No:</strong> <span id="reportExamNo"></span></p>
            <p><strong>TERM:</strong> <span id="reportTerm"></span></p>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="resultsTable">
            <thead>
                <tr>
                    <th style="width: 20%;">SUBJECT</th>
                    <th style="width: 10%;">SCORE</th>
                    <th style="width: 10%;">GRADE</th>
                    <th style="width: 10%;">POSITION</th>
                    <th style="width: 30%;">REMARKS</th>
                    <th style="width: 20%;">TEACHER</th>
                </tr>
            </thead>
            <tbody id="reportBody">
            </tbody>
        </table>
    </div>

    <div id="summaryAndKeyWrapper">
        <div id="reportSummary"><br>
           <span style="font-size: 1.25em;"> <div id="averageLine" class="hidden">Average:<strong> <span id="reportAverage"></span></div></strong>
            <div id="aggregateLine" class="hidden">Aggregate:<strong> <span id="reportAggregate"></span></div><br></strong>
    <div>Position in Class:<strong> <span id="reportPosition"></span></div><br></strong>
    <div>Remark:<strong> <span id="reportOverallRemark"></span></div></strong>
        </div>

        <div id="gradeKeyPlaceholder">
        </div>
    </div>

    <p style="margin-top: 20px; color: black;"><strong><p style="text-align: left;">COMMENT:</strong></p>
    <div id="reportComment" style="padding: 10px; border: 1px solid black; min-height: 40px; text-align: left;">
    </div>

    <div style="text-align: right; margin-top: 20px;">
        <button class="view-btn small-btn" onclick="window.print()" style="background: #17a2b8; color: white;">Print</button>
        <button class="view-btn small-btn" onclick="openFullPdf()" style="background: #17a2b8; color: white;">Save (PDF)</button>
    </div>
    <p style="text-align: center; font-size: 8pt; margin-top: 10px; color: black;">Progress of results covers one A4 page only.</p>
</div>

<div id="adminLoginPage" class="page">
    <h2 id="adminLabel">Admin Login</h2>
    <input type="password" id="adminPassword" placeholder="Enter Password">
    <button id="adminLoginBtn" onclick="verifyAdmin()">Login</button>
    <button onclick="backToInitialPage()">Back</button>
</div>

<div id="adminHomePage" class="page">
    <h2>Admin Dashboard</h2>
    <input type="password" id="githubToken" placeholder="Authorization Code" style="margin-bottom: 20px;">
    <button onclick="openDataEntryAuth()">DATA</button>
    <button onclick="openUploadsAuth()">UPLOADS</button>
    <button onclick="openSheetsPage()">SHEETS</button>
    <button onclick="backToInitialPage()">Logout</button>
</div>

<div id="dataEntryPage" class="page">
    <h2>Enter Student Scores</h2>
    <button onclick="openAdminHome()" style="position: absolute; top: 10px; left: 10px; width: auto; padding: 5px 10px; max-width: none !important; margin: 0;">Back</button>

    <label for="dataClassSelect">Select Class/Form</label>
    <select id="dataClassSelect" onchange="loadStudentsForDataEntry()">
        <option value="">-- Select Class --</option>
        <option value="form1">Form 1</option>
        <option value="form2">Form 2</option>
        <option value="form3">Form 3</option>
        <option value="form4">Form 4</option>
    </select>

    <label for="dataStudentSelect">Select Student Exam Number</label>
    <select id="dataStudentSelect">
        <option value="">-- Select Student --</option>
    </select>

    <label for="dataSubjectSelect">Select Subject</label>
    <select id="dataSubjectSelect">
        <option value="">-- Select Subject --</option>
    </select>

    <label for="dataScoreInput">Enter Score</label>
    <input type="text" id="dataScoreInput" placeholder="Enter Score (e.g. 75, X, or -)">

    <button onclick="submitScore()">Submit Score</button>
    <button onclick="deleteScore()" style="background: #e74c3c;">Delete Score (Set to '-')</button>

    <button onclick="saveAllScoresToRepo()">Save All Data</button>
    <button onclick="openScoreSheetView()">Score Sheet</button>
    <p style="font-size:11px; margin-top: 15px; color: #e74c3c;">NOTE: Scores are stored in memory until 'Save All Data to Repo' is clicked to commit changes.</p>
</div>

<div id="scoreSheetView" class="page">
    <h2>Score Sheet View</h2>
    <button onclick="openDataEntryPage()" style="position: absolute; top: 10px; left: 10px; width: auto; padding: 5px 10px; max-width: none !important; margin: 0;">Back</button>

    <label for="sheetClassSelect">Select Class/Form</label>
    <select id="sheetClassSelect" onchange="displayScoreSheet()">
        <option value="">-- Select Class --</option>
        <option value="form1">Form 1</option>
        <option value="form2">Form 2</option>
        <option value="form3">Form 3</option>
        <option value="form4">Form 4</option>
    </select>

    <button onclick="printSheet('scoreSheetView')" class="small-btn" style="float: right; margin-top: 10px; max-width: 150px;">Print Sheet (Landscape)</button>

    <div id="scoreSheetTableWrapper" class="table-wrapper" style="text-align: center;">
    </div>
</div>

<div id="uploadsPage" class="page">
    <h2>Uploads and Configuration</h2>
    <button onclick="openAdminHome()" style="position: absolute; top: 10px; left: 10px; width: auto; padding: 5px 10px; max-width: none !important; margin: 0;">Back</button>

    <hr style="margin: 20px 0; border: 1px solid #eee;">
    <h3>Report Configuration</h3>
    <label for="reportTermSelect">Select Current Term:</label>
    <select id="reportTermSelect">
        <option value="1">Term 1</option>
        <option value="2">Term 2</option>
        <option value="3">Term 3</option>
    </select>
    <label for="generalCommentInput">General Report Comment:</label>
    <textarea id="generalCommentInput" rows="3" placeholder="Enter comment for all reports..."></textarea>

    <hr style="margin: 20px 0; border: 1px solid #eee;">
    <h3>Assign Subject Teachers (Per Class)</h3>
    <label for="classTeacherDropdown">Select Class to Configure Teachers:</label>
    <select id="classTeacherDropdown" onchange="populateTeacherInputs()">
        <option value="form1">Form 1</option>
        <option value="form2">Form 2</option>
        <option value="form3">Form 3</option>
        <option value="form4">Form 4</option>
    </select>
    <div id="teacherAssignmentPanel">
    </div>
    <button onclick="handleSaveConfig()">Save Configuration</button>

    <hr style="margin: 20px 0; border: 1px solid #ccc;">
    <h3>Manage CSV Files</h3>
    <label for="classDropdown">Select Class:</label>
    <select id="classDropdown">
        <option value="">--Select Class--</option>
        <option value="form1">Form 1</option>
        <option value="form2">Form 2</option>
        <option value="form3">Form 3</option>
        <option value="form4">Form 4</option>
    </select>
    <input type="file" id="csvUpload" accept=".csv">
    <button onclick="uploadCSV()">Upload CSV</button>
    <label for="deleteDropdown">Select File to Delete:</label>
    <select id="deleteDropdown">
        <option value="">-- Select CSV File --</option>
    </select>
    <button onclick="deleteCSV()">Delete Selected CSV</button>
    <button onclick="refreshFileList()">â†» Refresh List</button>
</div>

<div id="sheetsPage" class="page">
    <h2>Sheets Overview</h2>
    <button onclick="openAdminHome()" style="position: absolute; top: 10px; left: 10px; width: auto; padding: 5px 10px; max-width: none !important; margin: 0;">Back</button>

    <!-- Progress Sheet Selection Section -->
    <div id="progressSheetSelection" style="margin-top: 20px;">
        <label for="progressClassSelect">Select Class/Form</label>
        <select id="progressClassSelect">
            <option value="">-- Select Class --</option>
            <option value="form1">Form 1</option>
            <option value="form2">Form 2</option>
            <option value="form3">Form 3</option>
            <option value="form4">Form 4</option>
        </select>
        <label for="progressExamNumber">Enter Exam Number</label>
        <input type="text" id="progressExamNumber" placeholder=" ">
        <button onclick="openStudentProgressSheet()" style="margin-top: 10px;">View Student Progress</button>
    </div>

    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
        <button onclick="openGradesPage()" style="width: 195px; max-width: 195px; margin-top: 0;">View Grade Sheet</button>
        <button onclick="openAnalysisSelector()" style="width: 195px; max-width: 195px; margin-top: 0;">View Analysis</button>
    </div>
</div>

<div id="gradesPage" class="page">
    <h2>Grades Sheet View</h2>
    <button onclick="openSheetsPage()" style="position: absolute; top: 10px; left: 10px; width: auto; padding: 5px 10px; max-width: none !important; margin: 0;">Back</button>

    <label for="gradesClassSelect">Select Class/Form</label>
    <select id="gradesClassSelect" onchange="displayGradesSheet()">
        <option value="">-- Select Class --</option>
        <option value="form1">Form 1</option>
        <option value="form2">Form 2</option>
        <option value="form3">Form 3</option>
        <option value="form4">Form 4</option>
    </select>

    <button onclick="printSheet('gradesPage')" class="small-btn" style="float: right; margin-top: 10px; max-width: 150px;">Print Sheet (Landscape)</button>

    <div id="gradesSheetTableWrapper" class="table-wrapper" style="text-align: center;">
    </div>
</div>

<div id="analysisSelectorPage" class="page">
    <h2>Select Class for Analysis</h2>
    <button onclick="openSheetsPage()" style="position: absolute; top: 10px; left: 10px; width: auto; padding: 5px 10px; max-width: none !important; margin: 0;">Back</button>

    <label for="analysisClassSelect">Select Class/Form</label>
    <select id="analysisClassSelect">
        <option value="">-- Select Class --</option>
        <option value="form1">Form 1</option>
        <option value="form2">Form 2</option>
        <option value="form3">Form 3</option>
        <option value="form4">Form 4</option>
    </select>
    <button onclick="openAnalysisPage()">Generate Analysis Report</button>
</div>

<div id="analysisPage" class="page">
    <h2 id="analysisTitle">Class Analysis Report</h2>
    <button onclick="openAnalysisSelector()" style="position: absolute; top: 10px; left: 10px; width: auto; padding: 5px 10px; max-width: none !important; margin: 0;">Back</button>
    <button onclick="printSheet('analysisPage')" class="small-btn" style="float: right; margin-top: 10px; max-width: 150px;">Print Analysis (Landscape)</button>
    <div id="analysisTableWrapper" class="table-wrapper"> </div>
</div>

<script>
// --- GITHUB CONSTANTS ---
const GITHUB_USER = 'kawalepvt';
const GITHUB_REPO = 'kw';
const CONFIG_FILE = 'config.json';
const ADMIN_PASSWORD = '001'; // Placeholder for security testing/local use

// --- CONFIGURATION STATE ---
let currentConfig = null;
let configSha = null;
let currentClassData = {}; // Cache for CSV data (key: form, value: student array)
let currentDataSha = {}; // NEW: Cache for the SHA of the current CSV files
// Preserved: Global variable to track the page that called loadResults()
let lastCallingPage = 'initialPage';

// --- STATIC CONSTANTS (MODIFIED) ---
const SUBJECT_MAP = {
    "Agriculture": "Agric",
    "Bible Knowledge": "BK",
    "Biology": "Bio",
    "Chemistry": "Chem",
    "Chichewa": "Chich",
    "English": "Eng",
    "Geography": "Geo",
    "History": "Hist",
    "Mathematics": "Maths",
    "Physics": "Phys",
    "Social/Life": "S/Life"
};
const ALL_SUBJECTS = Object.keys(SUBJECT_MAP); // Full names used for internal logic
const BASE_HEADERS = ["STUDENT'S NAME", "Exam Number", "Date of Birth"];
const ALL_HEADERS = [...BASE_HEADERS, ...ALL_SUBJECTS];
const ALL_CLASSES = ['form1', 'form2', 'form3', 'form4'];
const DEFAULT_TEACHER = 'TBA';
const API_BASE = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/`;

// Grade boundary definitions
const GRADE_KEY_LOWER = {
    A: 80,
    B: 70,
    C: 56,
    D: 33,
    F: 0
}; // Lower forms use A-F
const GRADE_KEY_UPPER = {
    1: 80,
    2: 71,
    3: 66,
    4: 61,
    5: 55,
    6: 46,
    7: 41,
    8: 33,
    9: 0
}; // Upper forms use 1-9 (Aggregate)

// --- UTILITY FUNCTIONS ---

function computeGradeSheetPositions(students) {
    const sorted = [...students].sort((a,b)=>b.aggregate - a.aggregate);
    let lastAgg = null, lastPos = 0;

    sorted.forEach((s,i)=>{
        const pos = (s.aggregate === lastAgg) ? lastPos : i + 1;
        s.__gradePosition = pos;
        lastAgg = s.aggregate;
        lastPos = pos;
    });
    return sorted;
}


/* === COMPETITION POSITIONING (1,1,1,4) === */
function computePositionsByAggregate(students) {
    const sorted = [...students].sort((a,b)=>b.aggregate - a.aggregate);
    let lastAgg = null, lastPos = 0;

    sorted.forEach((s,i)=>{
        const pos = (s.aggregate === lastAgg) ? lastPos : i + 1;
        s.position = pos;
        lastAgg = s.aggregate;
        lastPos = pos;
    });
    return sorted;
}

/* === BEST SIX AGGREGATE === */
function computeBestSixAggregate(form, student) {
    let values = [];

    for (const subject of ALL_SUBJECTS) {
        const score = student[subject];
        if (!score) continue;
        const grade = getGradeAndRemark(form, score).grade;

        if (form === 'form1' || form === 'form2') {
            if (['A','B','C','D','F'].includes(grade)) values.push(grade);
        } else {
            if (!isNaN(parseInt(grade))) values.push(parseInt(grade));
        }
    }

    if (form === 'form1' || form === 'form2') {
        const order = ['A','B','C','D','F'];
        values.sort((a,b)=>order.indexOf(a)-order.indexOf(b));
        return values.length >= 6 ? values.slice(0,6).length : '';
    } else {
        values.sort((a,b)=>a-b);
        return values.length >= 6 ? values.slice(0,6).reduce((x,y)=>x+y,0) : '';
    }
}

/* === PASS / FAIL === */
function computeFinalRemark(form, student) {
    let passCount = 0;
    const eng = student['English'];
    if (!eng) return 'Fail';
    const engGrade = getGradeAndRemark(form, eng).grade;

    function lowerPass(g){ return ['A','B','C','D'].includes(g); }
    function upperPass(g){ return parseInt(g) <= 8; }

    for (const subject of ALL_SUBJECTS) {
        const s = student[subject];
        if (!s) continue;
        const g = getGradeAndRemark(form, s).grade;

        if ((form==='form1'||form==='form2') && lowerPass(g)) passCount++;
        if ((form==='form3'||form==='form4') && upperPass(g)) passCount++;
    }

    if (form==='form1'||form==='form2') {
        return (passCount>=6 && lowerPass(engGrade)) ? 'Pass' : 'Fail';
    }
    return (passCount>=6 && upperPass(engGrade)) ? 'Pass' : 'Fail';
}


/* === SUBJECT POSITION + LOWER FORM REMARK HELPERS === */
function computeSubjectPositions(form, subject, classData) {
    const scored = classData
        .map(s => ({ exam: s["Exam Number"], v: parseInt(s[subject]) }))
        .filter(x => !isNaN(x.v))
        .sort((a,b)=>b.v-a.v);

    const posMap = {};
    let lastScore = null, lastPos = 0;
    scored.forEach((x, i) => {
        const pos = (x.v === lastScore) ? lastPos : i + 1;
        posMap[x.exam] = pos;
        lastScore = x.v; lastPos = pos;
    });
    return posMap;
}

function lowerFormRemarkFromGrade(g){
    if(g==='A') return 'Excellent';
    if(g==='B') return 'Very Good';
    if(g==='C') return 'Good';
    if(g==='D') return 'Average';
    if(g==='F') return 'Fail';
    return '-';
}
/* === COMPETITION RANKING (1,1,1,4) === */
function computeCompetitionRanks(entries, valueFn) {
    const sorted = entries
        .map(e => ({ key: e.key, val: valueFn(e) }))
        .sort((a,b)=>b.val - a.val);

    const ranks = {};
    let lastVal = null, lastRank = 0;

    sorted.forEach((e, i) => {
        const rank = (e.val === lastVal) ? lastRank : i + 1;
        ranks[e.key] = rank;
        lastVal = e.val;
        lastRank = rank;
    });
    return ranks;
}
function showLoading() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'flex';
    setTimeout(() => {
        overlay.style.opacity = '1';
        overlay.style.visibility = 'visible';
    }, 10);
    updateLoadingPercent(0);
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.opacity = '0';
    setTimeout(() => {
        overlay.style.visibility = 'hidden';
        overlay.style.display = 'none';
    }, 300);
}

function updateLoadingPercent(percent) {
    document.getElementById('loadingPercent').textContent = `${percent}%`;
}

function goToPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.style.display = 'none';
    });
    document.getElementById(pageId).style.display = 'block';
}

function getSubjectShortName(fullName) {
    return SUBJECT_MAP[fullName] || fullName.substring(0, 4);
}

function getDefaultConfig() {
    const teachers = {};
    ALL_CLASSES.forEach(form => {
        teachers[form] = {};
        ALL_SUBJECTS.forEach(subject => {
            teachers[form][subject] = DEFAULT_TEACHER;
        });
    });
    return {
        term: '3',
        generalComment: 'Excellent effort. Keep up the hard work.',
        gradeKeyLower: GRADE_KEY_LOWER,
        gradeKeyUpper: GRADE_KEY_UPPER,
        teachers: teachers
    };
}

function standardizeDateForComparison(dateStr) {
    if (!dateStr) return null;
    try {
        const date = new Date(dateStr);
        if (isNaN(date)) {
            const parts = dateStr.split(/[-/]/);
            if (parts.length === 3 && parts[0].length <= 2 && parts[1].length <= 2) {
                const [d, m, y] = parts;
                return `${y.padStart(4, '20')}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            }
        }
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    } catch (e) {
        console.error("Date standardization failed:", e);
        return null;
    }
}

function getGradeAndRemark(form, score) {
    try {
        const isLowerForm = form === 'form1' || form === 'form2';
        
        // Ensure currentConfig and grade keys are available
        if (!currentConfig || !currentConfig.gradeKeyLower || !currentConfig.gradeKeyUpper) {
            console.error('Grade configuration not loaded');
            return { grade: '-', remark: 'Config Error' };
        }
        
        const key = isLowerForm ? currentConfig.gradeKeyLower : currentConfig.gradeKeyUpper;
        let grade = '-';
        let remark = '-';

        if (score === 'N') {
            return { grade: 'N', remark: 'No Mark' };
        }
        if (score === 'X') {
            return { grade: 'X', remark: 'Not Enrolled' };
        }
        if (score === '-') {
            return { grade: '-', remark: 'Missing Score' };
        }

        const numericScore = parseInt(score);
        if (isNaN(numericScore)) {
             return { grade: '-', remark: 'Invalid Score' };
        }

        if (isLowerForm) {
            if (numericScore >= key.A) {
                grade = 'A';
            } else if (numericScore >= key.B) {
                grade = 'B';
            } else if (numericScore >= key.C) {
                grade = 'C';
            } else if (numericScore >= key.D) {
                grade = 'D';
            } else if (numericScore >= key.E) {
                grade = 'E';
            } else {
                grade = 'F';
            }
            if (numericScore >= key.C) {
                remark = 'Pass';
            } else {
                remark = 'Fail';
            }
        } else {
            if (numericScore >= key[1]) {
                grade = '1';
            } else if (numericScore >= key[2]) {
                grade = '2';
            } else if (numericScore >= key[3]) {
                grade = '3';
            } else if (numericScore >= key[4]) {
                grade = '4';
            } else if (numericScore >= key[5]) {
                grade = '5';
            } else if (numericScore >= key[6]) {
                grade = '6';
            } else if (numericScore >= key[7]) {
                grade = '7';
            } else if (numericScore >= key[8]) {
                grade = '8';
            } else {
                grade = '9';
            }
            if (parseInt(grade) <= 1 ) {
                remark = 'Distinction';
            } else if (parseInt(grade) <=2) {
                 remark = 'Distinction';
            } else if (parseInt(grade) <=3) {
                 remark = 'Strong Credit';
            } else if (parseInt(grade) <=4) {
                 remark = 'Credit';
            } else if (parseInt(grade) <=5) {
                 remark = 'Credit';
            } else if (parseInt(grade) <=6) {
                 remark = 'Credit';
            } else if (parseInt(grade) <=7) {
                 remark = 'Pass';
            } else if (parseInt(grade) <=8) {
                 remark = 'Pass';
            } else if (parseInt(grade) <=9) {
                 remark = 'Fail';
            } else {
                remark = 'Fail';
            }
        }
        return { grade: grade.toString(), remark: remark };
    } catch (error) {
        console.error('Error in getGradeAndRemark:', error);
        return { grade: '-', remark: 'Error' };
    }
}


function isStudentPass(form, student) {
    let passCount = 0;

    const eng = student['English'];
    if (!eng) return false;
    const engGrade = getGradeAndRemark(form, eng).grade;

    function lowerPass(g){ return ['A','B','C','D'].includes(g); }
    function upperPass(g){ return parseInt(g) <= 8; }

    for (const subject of ALL_SUBJECTS) {
        const raw = student[subject];
        if (!raw) continue;
        const grade = getGradeAndRemark(form, raw).grade;

        if ((form==='form1' || form==='form2') && lowerPass(grade)) passCount++;
        if ((form==='form3' || form==='form4') && upperPass(grade)) passCount++;
    }

    if (form==='form1' || form==='form2') {
        return passCount >= 6 && lowerPass(engGrade);
    }
    return passCount >= 6 && upperPass(engGrade);
}

function getGradeKeyTableHTML(form) {
    const isLower = form === 'form1' || form === 'form2';
    const key = isLower ? currentConfig.gradeKeyLower : currentConfig.gradeKeyUpper;
    let html = `
        <h3>Grade Key:</h3>
        <table id="gradeKeyTableNew">
        <thead>
            <tr><th>Grade</th><th>Score Range</th></tr>
        </thead>
        <tbody>`;

    let entries = Object.entries(key);
    entries.sort((a, b) => b[1] - a[1]);

    entries.forEach(([grade, score], index) => {
        let displayRange = '';
        if (index === 0) {
            displayRange = `${score}+`;
        } else {
            const nextHigherScore = entries[index - 1][1];
            displayRange = `${score} - ${nextHigherScore - 1}`;
        }

        if (isLower && grade === 'F') {
             displayRange = `0 - ${entries[entries.length - 2][1] - 1}`;
        } else if (!isLower && grade === '9') {
             displayRange = `0 - ${entries[entries.length - 2][1] - 1}`;
        }

        html += `<tr><td>${grade}</td><td>${displayRange}</td></tr>`;
    });

    html += '</tbody></table>';
    return html;
}

function printSheet(pageId) {
    const pageElement = document.getElementById(pageId);
    if (!pageElement) return;

    const styleOverride = document.createElement('style');
    styleOverride.id = 'landscapePrintStyle';
    styleOverride.innerHTML = `
        @page { size: A4 landscape !important; margin: 0.5cm !important; }
        body * { visibility: hidden !important; }
        body { visibility: visible !important; }
        #${pageId} {
            visibility: visible !important;
            display: block !important;
            padding: 15px !important;
            margin: 0 auto !important;
            position: absolute !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            top: 0;
            width: 100% !important;
            max-width: none !important;
            box-shadow: none !important;
        }
        #${pageId} *,
        #${pageId} .table-wrapper,
        #${pageId} table,
        #${pageId} thead,
        #${pageId} tbody,
        #${pageId} tr,
        #${pageId} td,
        #${pageId} th {
            visibility: visible !important;
        }
        #${pageId} button, #${pageId} select, #${pageId} label, #${pageId} input {
            display: none !important;
        }
        @media (min-width: 768px) {
            #gradesTable, #analysisTable, #scoresTable {
                width: 100% !important;
                min-width: 100% !important;
            }
        }
    `;
    document.head.appendChild(styleOverride);

    window.print();

    setTimeout(() => {
        const style = document.getElementById('landscapePrintStyle');
        if (style) {
            style.remove();
        }
    }, 100);
}

async function commitFile(path, message, content, sha, token, method) {
    const url = `${API_BASE}${path}`;
    const headers = {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
    };

    const body = {
        message: message,
        sha: sha,
        content: content,
        branch: 'main'
    };

    try {
        const response = await fetch(url, {
            method: method,
            headers: headers,
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error('GitHub API Response Error:', errorData);
            throw new Error(`GitHub API Error (${method} ${path}): ${response.status} - ${errorData.message || response.statusText}`);
        }
        return await response.json();
    } catch (error) {
        console.error('Commit/Delete Failed:', error);
        alert(`Operation Failed: ${error.message}. Check your Authorization Code and repository access.`);
        return null;
    }
}

async function getCSVFileSha(form, token) {
    const fileName = `${form}.csv`;
    const url = `${API_BASE}${fileName}`;

    try {
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const data = await response.json();
            return data.sha;
        } else if (response.status === 404) {
            return null;
        } else {
            throw new Error(`Failed to fetch SHA for ${fileName}: ${response.statusText}`);
        }
    } catch (error) {
        console.error(`Error fetching SHA for ${fileName}:`, error);
        throw error;
    }
}

async function fetchClassData(form) {
    showLoading();
    if (currentClassData[form] && currentClassData[form].length > 0) {
        hideLoading();
        return currentClassData[form];
    }

    const token = document.getElementById('githubToken') ? document.getElementById('githubToken').value : null;
    const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

    try {
        updateLoadingPercent(20);
        const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${form}.csv`);

        if (!response.ok) {
            console.warn(`CSV file for ${form} not found.`);
            return [];
        }
        const csv = await response.text();
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true, columns: ALL_HEADERS });
        const data = parsed.data.filter(s => s && s["Exam Number"]);
        currentClassData[form] = data;
        updateLoadingPercent(80);
        return data;
    } catch (error) {
        console.error(`Error fetching data for ${form}:`, error);
        return [];
    } finally {
        hideLoading();
    }
}

async function fetchConfig(token) {
    showLoading();
    try {
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const response = await fetch(`${API_BASE}${CONFIG_FILE}`, { headers });

        if (!response.ok) {
            if (response.status === 404) {
                return { config: getDefaultConfig(), sha: null };
            }
            if (response.status === 401 || response.status === 403) {
                throw new Error("Authentication failed for config file. Check your Authorization Code.");
            }
            throw new Error(`Failed to fetch config file: ${response.statusText}`);
        }

        const data = await response.json();
        configSha = data.sha;
        const content = JSON.parse(atob(data.content));
        const defaultConfig = getDefaultConfig();
        currentConfig = {
            ...defaultConfig,
            ...content,
            teachers: { ...defaultConfig.teachers, ...content.teachers }
        };

        return { config: currentConfig, sha: configSha };

    } catch (error) {
        console.error('Error fetching config:', error);
        alert(`Error: ${error.message}`);
        return { config: getDefaultConfig(), sha: null };
    } finally {
        hideLoading();
    }
}

async function initializeConfig(token) {
    const result = await fetchConfig(token);
    currentConfig = result.config;
    configSha = result.sha;

    if(document.getElementById('reportTermSelect')) {
         document.getElementById('reportTermSelect').value = currentConfig.term;
    }
    if(document.getElementById('generalCommentInput')) {
        document.getElementById('generalCommentInput').value = currentConfig.generalComment;
    }

    populateTeacherInputs();
}

async function handleSaveConfig() {
    const token = document.getElementById('githubToken').value;
    if (!token) {
        alert('Please enter your Authorization Code.');
        return;
    }

    showLoading();
    updateLoadingPercent(10);

    const newConfig = {
        term: document.getElementById('reportTermSelect').value,
        generalComment: document.getElementById('generalCommentInput').value,
        gradeKeyLower: currentConfig.gradeKeyLower,
        gradeKeyUpper: currentConfig.gradeKeyUpper,
        teachers: {}
    };

    ALL_CLASSES.forEach(form => {
        newConfig.teachers[form] = {};
        ALL_SUBJECTS.forEach(subject => {
            const shortName = getSubjectShortName(subject);
            const inputId = `${form}_${shortName}`;
            const inputElement = document.getElementById(inputId);

            if (inputElement) {
                newConfig.teachers[form][subject] = inputElement.value.trim() || DEFAULT_TEACHER;
            } else {
                newConfig.teachers[form][subject] = currentConfig.teachers[form][subject] || DEFAULT_TEACHER;
            }
        });
    });

    updateLoadingPercent(40);

    const jsonContent = JSON.stringify(newConfig, null, 2);
    const base64Content = btoa(jsonContent);
    const commitMessage = `Update configuration: term ${newConfig.term}, ${new Date().toLocaleString()}`;

    const result = await commitFile(
        CONFIG_FILE,
        commitMessage,
        base64Content,
        configSha,
        token,
        'PUT'
    );

    hideLoading();
    if (result) {
        configSha = result.content.sha;
        currentConfig = newConfig;
        alert('Configuration saved successfully!');
    }
}

async function uploadCSV() {
    const token = document.getElementById('githubToken').value;
    const form = document.getElementById('classDropdown').value;
    const fileInput = document.getElementById('csvUpload');

    if (!token) {
        alert('Please enter your Authorization Code.');
        return;
    }
    if (!form) {
        alert('Please select a Class.');
        return;
    }
    if (!fileInput.files.length) {
        alert('Please select a CSV file.');
        return;
    }

    const file = fileInput.files[0];
    const fileName = `${form}.csv`;
    const commitMessage = `Upload new data for ${form} (${file.name})`;

    showLoading();
    updateLoadingPercent(10);

    try {
        const fileContent = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        const base64Content = fileContent.split(',')[1];

        updateLoadingPercent(40);

        let sha = await getCSVFileSha(form, token);

        updateLoadingPercent(70);

        const result = await commitFile(
            fileName,
            commitMessage,
            base64Content,
            sha,
            token,
            'PUT'
        );

        hideLoading();
        if (result) {
            alert(`File ${fileName} uploaded/updated successfully!`);
            currentClassData[form] = null;
            currentDataSha[form] = result.content.sha;
            refreshFileList();
            fileInput.value = '';
        }

    } catch (error) {
        hideLoading();
        console.error('CSV Upload failed:', error);
        alert(`CSV Upload Failed: ${error.message}`);
    }
}

async function refreshFileList() {
    const token = document.getElementById('githubToken').value;
     const deleteDropdown = document.getElementById('deleteDropdown');
    deleteDropdown.innerHTML = '<option value="">-- Select CSV File --</option>';
    currentDataSha = {};

    if (!token) {
        alert('Please enter your Authorization Code.');
        return;
    }

    showLoading();
    updateLoadingPercent(10);

    try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
            throw new Error(`Failed to list files: ${response.statusText}`);
        }

        const files = await response.json();

        updateLoadingPercent(40);

        files.filter(f => f.type === 'file' && f.name.endsWith('.csv')).forEach(file => {
            deleteDropdown.innerHTML += `<option value="${file.name}|${file.sha}">${file.name}</option>`;
            currentDataSha[file.name.replace('.csv', '')] = file.sha;
        });

    } catch (error) {
        console.error('Error fetching file list:', error);
        alert(`Error fetching file list: ${error.message}`);
    } finally {
        hideLoading();
    }
}

async function deleteCSV() {
    const token = document.getElementById('githubToken').value;
    const deleteDropdown = document.getElementById('deleteDropdown');
    const selectedValue = deleteDropdown.value;

    if (!token) {
        alert('Please enter your Authorization Code.');
        return;
    }
    if (!selectedValue) {
        alert('Please select a file to delete.');
        return;
    }

    const [fileName, sha] = selectedValue.split('|');
    const formKey = fileName.replace('.csv', '');

    if (!confirm(`Are you sure you want to delete ${fileName}? This action cannot be undone.`)) {
        return;
    }

    showLoading();
    updateLoadingPercent(10);

    const commitMessage = `Delete data file ${fileName}`;

    const result = await commitFile(
        fileName,
        commitMessage,
        null,
        sha,
        token,
        'DELETE'
    );

    hideLoading();
    if (result) {
        alert(`File ${fileName} deleted successfully!`);
        currentClassData[formKey] = null;
        delete currentDataSha[formKey];
        refreshFileList();
    }
}

async function submitScore() {
    const form = document.getElementById('dataClassSelect').value;
    const studentNumber = document.getElementById('dataStudentSelect').value;
    const subject = document.getElementById('dataSubjectSelect').value;
    const rawScore = document.getElementById('dataScoreInput').value.trim();

    if (!form || !studentNumber || !subject || rawScore === '') {
        alert('Please select a Class, Student, Subject, and enter a Score.');
        return;
    }

    const upperScore = rawScore.toUpperCase();
    const numericScore = parseInt(rawScore);
    if ((isNaN(numericScore) || numericScore < 0 || numericScore > 100) && upperScore !== 'N' && upperScore !== 'X' && upperScore !== '-') {
        alert('Invalid score. Please enter a number between 0-100, "N" (No Mark), "X" (Not Enrolled), or "-" (Deleted/Missing).');
        return;
    }

    showLoading();
    updateLoadingPercent(10);

    const classData = await fetchClassData(form);
    if (!classData || classData.length === 0) {
        alert(`Could not load data for ${form}. Cannot submit score.`);
        hideLoading();
        return;
    }

    const studentIndex = classData.findIndex(s => s["Exam Number"] === studentNumber);

    if (studentIndex === -1) {
        alert('Student not found in the loaded class data.');
        hideLoading();
        return;
    }

    classData[studentIndex][subject] = rawScore;
    currentClassData[form] = classData;

    updateLoadingPercent(100);
    hideLoading();
    alert(`Score for ${studentNumber} in ${subject} set to ${rawScore}. Click 'Save All Data' to permanently save changes.`);

    displayScoreSheet();
}

async function deleteScore() {
    const form = document.getElementById('dataClassSelect').value;
    const studentNumber = document.getElementById('dataStudentSelect').value;
    const subject = document.getElementById('dataSubjectSelect').value;

    if (!form || !studentNumber || !subject) {
        alert('Please select a Class, Student, and Subject to delete the score for.');
        return;
    }

    if (!confirm(`Are you sure you want to set the score for ${studentNumber} in ${subject} to '-' (Deleted/Missing Mark)?`)) {
        return;
    }

    showLoading();
    updateLoadingPercent(10);

    const classData = await fetchClassData(form);
    if (!classData || classData.length === 0) {
        alert(`Could not load data for ${form}. Cannot delete score.`);
        hideLoading();
        return;
    }

    const studentIndex = classData.findIndex(s => s["Exam Number"] === studentNumber);

    if (studentIndex === -1) {
        alert('Student not found in the loaded class data.');
        hideLoading();
        return;
    }

    classData[studentIndex][subject] = '-';
    currentClassData[form] = classData;

    updateLoadingPercent(100);
    hideLoading();
    alert(`Score for ${studentNumber} in ${subject} deleted (set to '-'). Click 'Save All Data to Repo' to permanently save changes.`);

    displayScoreSheet();
}

async function saveAllScoresToRepo() {
    const token = document.getElementById('githubToken').value;
    const form = document.getElementById('dataClassSelect').value;

    if (!token) {
        alert('Please enter your Authorization Code in the Admin Dashboard.');
        return;
    }
    if (!form) {
        alert('Please select a Class whose data you want to save.');
        return;
    }

    const classData = currentClassData[form];
    if (!classData || classData.length === 0) {
        alert('No data has been loaded or modified for this class to save.');
        return;
    }

    if (!confirm(`Are you sure you want to overwrite ${form}.csv on GitHub with the current in-memory data?`)) {
        return;
    }

    showLoading();
    updateLoadingPercent(10);

    const fileName = `${form}.csv`;

    try {
        const currentSha = await getCSVFileSha(form, token);
        updateLoadingPercent(30);

        const csvString = Papa.unparse(classData, {
            header: true,
            columns: ALL_HEADERS
        });
        updateLoadingPercent(60);

        const base64Content = btoa(csvString);
        const commitMessage = `Data Entry Update for ${form} on ${new Date().toLocaleString()}`;
        updateLoadingPercent(80);

        const result = await commitFile(
            fileName,
            commitMessage,
            base64Content,
            currentSha,
            token,
            'PUT'
        );

        hideLoading();
        if (result) {
            currentDataSha[form] = result.content.sha;
            currentClassData[form] = null;
            await fetchClassData(form);

            alert(`Successfully saved and committed data for ${form} to GitHub!`);
        }
    } catch (error) {
        hideLoading();
        console.error('Save Data Failed:', error);
        alert(`Data Save Failed: ${error.message}`);
    }
}

function populateTeacherInputs() {
    const form = document.getElementById('classTeacherDropdown').value;
    const panel = document.getElementById('teacherAssignmentPanel');
    panel.innerHTML = '';

    if (!form || !currentConfig || !currentConfig.teachers[form]) {
        panel.innerHTML = '<p style="margin-top: 10px;">Configuration not loaded or missing teacher data.</p>';
        return;
    }

    const sortedSubjects = [...ALL_SUBJECTS].sort();

    sortedSubjects.forEach(subject => {
        const teacher = currentConfig.teachers[form][subject] || DEFAULT_TEACHER;
        const shortName = getSubjectShortName(subject);

        panel.innerHTML += `
            <div class="teacher-input-group">
                <label for="${form}_${shortName}">${subject}</label>
                <input type="text" id="${form}_${shortName}" data-subject="${subject}" value="${teacher}">
            </div>
        `;
    });
}

function backToInitialPage() {
    goToPage('initialPage');
    document.getElementById('adminPassword').value = '';
    document.getElementById('githubToken').value = '';
    currentConfig = null;
    configSha = null;
    currentClassData = {};
    currentDataSha = {};
    initializeConfig(null);
}

function openAdminLogin() {
    goToPage('adminLoginPage');
}

async function verifyAdmin() {
    const password = document.getElementById('adminPassword').value;
    if (password === ADMIN_PASSWORD) {
        await initializeConfig(document.getElementById('githubToken').value);
        goToPage('adminHomePage');
    } else {
        alert('Invalid Password.');
    }
}

function openAdminHome() {
    goToPage('adminHomePage');
}

async function openUploadsAuth() {
    const token = document.getElementById('githubToken').value;
    if (!token) {
        alert('You need to provide Authorization Code to access this section.');
        return;
    }
    await initializeConfig(token);
    await refreshFileList();
    goToPage('uploadsPage');
}

function openDataEntryAuth() {
    const token = document.getElementById('githubToken').value;
    if (!token) {
        alert('You need to provide Authorization Code to access this section.');
        return;
    }
    openDataEntryPage();
}

async function loadResults(isStudentPortal) {
    try {
        const form = document.getElementById('selectedForm').value;
        const studentNumber = document.getElementById('studentNumberInput').value.trim().toUpperCase();
        const dob = document.getElementById('dobInput').value;

        if (!form || !studentNumber || (isStudentPortal && !dob)) {
            alert('Please fill in all required fields (Class, Exam Number, and Date of Birth).');
            return;
        }

        if (!currentConfig) {
            await initializeConfig(null);
        }

        showLoading();
        updateLoadingPercent(10);

        lastCallingPage = isStudentPortal ? 'initialPage' : 'sheetsPage';

        const data = await fetchClassData(form);
        updateLoadingPercent(50);

        if (data.length === 0) {
            alert(`No data found for ${form}. Please inform the admin.`);
            hideLoading();
            return;
        }

        const student = data.find(s => s["Exam Number"] === studentNumber);

        if (!student) {
            alert('Student not found in the records.');
            hideLoading();
            return;
        }

        if (isStudentPortal) {
            const storedDob = student["Date of Birth"] || '';
            const storedDateStandardized = standardizeDateForComparison(storedDob);
            const inputDateStandardized = standardizeDateForComparison(dob);

            if (!storedDateStandardized || storedDateStandardized !== inputDateStandardized) {
                alert('Date of Birth does not match the record for this Exam Number.');
                hideLoading();
                return;
            }
        }

        const studentsWithMetrics = [];
        for (const s of data) {
            const metrics = await calculateStudentMetrics(s, form);
            studentsWithMetrics.push({
                examNo: s["Exam Number"],
                metric: metrics.overallMetric,
                rankable: metrics.rankable
            });
        }

        studentsWithMetrics.sort((a, b) => a.metric - b.metric);
        let rankableStudents = studentsWithMetrics.filter(s => s.rankable);
        const totalRankableStudents = rankableStudents.length;

        const studentMetrics = await calculateStudentMetrics(student, form);
        updateLoadingPercent(75);

        document.getElementById('reportStudentName').textContent = student["STUDENT'S NAME"] || '-';
        document.getElementById('reportForm').textContent = form.toUpperCase();
        document.getElementById('reportExamNo').textContent = studentNumber;
        document.getElementById('reportTerm').textContent = currentConfig.term;
        document.getElementById('reportComment').textContent = currentConfig.generalComment;

        const reportBody = document.getElementById('reportBody');
        reportBody.innerHTML = '';

        const sortedSubjects = [...ALL_SUBJECTS].sort();

        sortedSubjects.forEach(subject => {
            const rawScore = student[subject];
            let displayScore = '-';
            let grade = '-';
            let remark = '-';

            if (rawScore !== undefined && rawScore !== null && rawScore.toString().trim() !== '') {
                displayScore = rawScore;
                const gr = getGradeAndRemark(form, rawScore);
                grade = gr.grade;
                remark = gr.remark;
            }

            const teacher = currentConfig.teachers[form][subject] || DEFAULT_TEACHER;

            const posMap = computeSubjectPositions(form, subject, data);
            const subjectPos = posMap[studentNumber] || '-';

            if (form === 'form1' || form === 'form2') {
                remark = lowerFormRemarkFromGrade(grade);
            }

            const row = reportBody.insertRow();
            row.insertCell().textContent = subject;
            row.insertCell().textContent = displayScore;
            row.insertCell().textContent = grade;
            row.insertCell().textContent = subjectPos;
            row.insertCell().textContent = remark;
            row.insertCell().textContent = teacher;
        });

        let overallRank = 'N/A';
        if (studentMetrics.rankable) {
            const studentMetric = rankableStudents.find(s => s.examNo === studentNumber);
            if (studentMetric) {
                const metricValue = studentMetric.metric;
                let actualRank = rankableStudents.findIndex(s => s.metric === metricValue) + 1;

                overallRank = `${actualRank}/${totalRankableStudents}`;
            }
        }

        document.getElementById('reportPosition').textContent = overallRank;
        document.getElementById('reportOverallRemark').textContent = computeFinalRemark(form, student);

        const isUpperForm = form === 'form3' || form === 'form4';
        const averageLine = document.getElementById('averageLine');
        const aggregateLine = document.getElementById('aggregateLine');

        if (isUpperForm) {
            aggregateLine.classList.remove('hidden');
            averageLine.classList.add('hidden');
            document.getElementById('reportAggregate').textContent = studentMetrics.aggregate;
        } else {
            averageLine.classList.remove('hidden');
            aggregateLine.classList.add('hidden');
            document.getElementById('reportAverage').textContent = studentMetrics.average > 0 ? studentMetrics.average.toFixed(2) : '0.00';
        }

        document.getElementById('gradeKeyPlaceholder').innerHTML = getGradeKeyTableHTML(form);

        updateLoadingPercent(100);
        hideLoading();
        goToPage('progressReport');
    } catch (error) {
        console.error('Error loading results:', error);
        alert(`Failed to load results: ${error.message}. Please check the console for details.`);
        hideLoading();
    }
}

function handleProgressBack() {
    if (lastCallingPage === 'initialPage') {
        goToPage('initialPage');
    } else if (lastCallingPage === 'sheetsPage') {
        goToPage('sheetsPage');
    }
}

function openFullPdf() {
    const studentName = document.getElementById('reportStudentName').textContent;
    const fileName = studentName.replace(/ /g, '_') + '_Report.pdf';

    const element = document.getElementById('progressReport');

    showLoading();
    updateLoadingPercent(10);

    html2canvas(element, {
        scale: 2,
        allowTaint: true,
        useCORS: true
    }).then(canvas => {
        updateLoadingPercent(50);
        const { jsPDF } = window.jspdf;
        const imgData = canvas.toDataURL('image/png');

        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'px',
            format: [canvas.width, canvas.height]
        });

        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);

        updateLoadingPercent(90);
        pdf.save(fileName);

        updateLoadingPercent(100);
        hideLoading();
    }).catch(error => {
        console.error("Error generating PDF:", error);
        alert("Failed to generate PDF. Check console for details.");
        hideLoading();
    });
}

async function loadBriefResults() {
    const form = document.getElementById('selectedForm').value;
    const studentNumber = document.getElementById('studentNumberInput').value.trim().toUpperCase();
    const dob = document.getElementById('dobInput').value;

    if (!form || !studentNumber || !dob) {
        alert('Please fill in all required fields (Class, Exam Number, and Date of Birth).');
        return;
    }

    if (!currentConfig) {
        await initializeConfig(null);
    }

    showLoading();
    updateLoadingPercent(10);

    const data = await fetchClassData(form);
    updateLoadingPercent(50);

    if (data.length === 0) {
        alert(`No data found for ${form}. Please inform the admin.`);
        hideLoading();
        return;
    }

    const student = data.find(s => s["Exam Number"] === studentNumber);

    if (!student) {
        alert('Student not found in the records.');
        hideLoading();
        return;
    }

    const storedDob = student["Date of Birth"] || '';
    const storedDateStandardized = standardizeDateForComparison(storedDob);
    const inputDateStandardized = standardizeDateForComparison(dob);

    if (!storedDateStandardized || storedDateStandardized !== inputDateStandardized) {
        alert('Date of Birth does not match the record for this Exam Number.');
        hideLoading();
        return;
    }

    const studentsWithMetrics = [];
    for (const s of data) {
        const metrics = await calculateStudentMetrics(s, form);
        studentsWithMetrics.push({
            examNo: s["Exam Number"],
            metric: metrics.overallMetric,
            rankable: metrics.rankable
        });
    }
    let rankableStudents = studentsWithMetrics.filter(s => s.rankable);
    rankableStudents.sort((a, b) => a.metric - b.metric);
    const totalRankableStudents = rankableStudents.length;

    const studentMetrics = await calculateStudentMetrics(student, form);
    updateLoadingPercent(75);

    document.getElementById('briefReportStudentName').textContent = student["STUDENT'S NAME"] || '-';
    document.getElementById('briefReportForm').textContent = form.toUpperCase();
    document.getElementById('briefReportExamNo').textContent = studentNumber;
    document.getElementById('briefReportTerm').textContent = currentConfig.term;

    const reportBody = document.getElementById('briefReportBody');
    reportBody.innerHTML = '';

    const sortedSubjects = [...ALL_SUBJECTS].sort();

    sortedSubjects.forEach(subject => {
        const rawScore = student[subject];
        let displayScore = '-';
        let grade = '-';

        if (rawScore !== undefined && rawScore !== null && rawScore.toString().trim() !== '') {
            displayScore = rawScore;
            const gr = getGradeAndRemark(form, rawScore);
            grade = gr.grade;
        }

        const row = reportBody.insertRow();
        row.insertCell().textContent = subject;
        row.insertCell().textContent = displayScore;
        row.insertCell().textContent = grade;
    });

    let overallRank = '-';
    if (studentMetrics.rankable) {
         const studentMetric = rankableStudents.find(s => s.examNo === studentNumber);
        if (studentMetric) {
            const metricValue = studentMetric.metric;
            let actualRank = rankableStudents.findIndex(s => s.metric === metricValue) + 1;
            overallRank = `${actualRank}/${totalRankableStudents}`;
        }
    }
    document.getElementById('briefReportPosition').textContent = overallRank;
    document.getElementById('briefReportOverallRemark').textContent = studentMetrics.overallRemark;

    const isUpperForm = form === 'form3' || form === 'form4';
    const averageLine = document.getElementById('briefAverageLine');
    const aggregateLine = document.getElementById('briefAggregateLine');

    if (isUpperForm) {
        aggregateLine.classList.remove('hidden');
        averageLine.classList.add('hidden');
        document.getElementById('briefReportAggregate').textContent = studentMetrics.aggregate;
    } else {
        averageLine.classList.remove('hidden');
        aggregateLine.classList.add('hidden');
        document.getElementById('briefReportAverage').textContent = studentMetrics.average > 0 ? studentMetrics.average.toFixed(2) : '0.00';
    }

    updateLoadingPercent(100);
    hideLoading();
    goToPage('briefReport');
}

function handleBriefBack() {
    goToPage('initialPage');
}

/* ======================
   UPDATED: calculateStudentMetrics
   - ensures BEST-6 aggregate is computed BEFORE ranking metric
   - uses isStudentPass(form, student) to set overallRemark for LOWER FORMS (form1/form2)
     so Pass = A-D in at least 6 subjects including English
   - preserves previous rankable logic and metrics structure
   ====================== */
async function calculateStudentMetrics(student, form){
    let totalScore = 0;
    let subjectsCount = 0;
    let nonNumericSubjectsCount = 0;
    let rankable = true;

    const sortedSubjects = [...ALL_SUBJECTS].sort();

    // Collect numeric scores and grades
    const gradeNums = []; // numeric grades (1..9) extracted from grade letters/numbers for upper forms
    for (const subject of sortedSubjects) {
        const rawScore = student[subject];

        if (rawScore === undefined || rawScore === null || rawScore === '') {
            continue;
        }

        if (rawScore === 'N' || rawScore === 'X' || rawScore === '-') {
            nonNumericSubjectsCount++;
            continue;
        }

        const score = parseInt(rawScore);
        if (!isNaN(score) && isFinite(score)) {
            // accumulate total/subject count for averages (lower forms)
            totalScore += score;
            subjectsCount++;

            // For upper forms capture the numeric grade (1..9) derived from score
            if (form === 'form3' || form === 'form4') {
                const { grade } = getGradeAndRemark(form, score);
                const numericGrade = parseInt(grade);
                if (!isNaN(numericGrade)) {
                    gradeNums.push(numericGrade);
                }
            }
        } else {
            nonNumericSubjectsCount++;
        }
    }

    // Determine rankable (unchanged criteria)
    if (subjectsCount < 4 || nonNumericSubjectsCount > 5) {
        rankable = false;
    }

    // Compute BEST SIX aggregate for upper forms (if possible)
    let aggregate = '-';
    if (form === 'form3' || form === 'form4') {
        if (gradeNums.length >= 6) {
            gradeNums.sort((a,b)=>a-b); // lower numeric grade is better
            aggregate = gradeNums.slice(0,6).reduce((a,b)=>a+b,0);
        } else {
            aggregate = '-';
        }
    }

    // Compute overallMetric used for ranking:
    // - For upper forms: use aggregate (lower is better) when rankable and aggregate numeric
    // - For lower forms: use negative totalScore so sorting ascending gives best first
    let overallMetric;
    if (!rankable) {
        overallMetric = (form === 'form3' || form === 'form4') ? 999 : 99999;
    } else {
        if (form === 'form3' || form === 'form4') {
            overallMetric = (typeof aggregate === 'number') ? aggregate : 999;
        } else {
            overallMetric = 0 - totalScore;
        }
    }

    // Determine overallRemark using the PASS rule requested:
    // For lower forms (form1/form2) use the exact pass rule:
    // Pass when student gets a grade of A-D in at least 6 subjects including English.
    // For upper forms keep the existing rule (grades 1-8 in 6 subjects incl English).
    let overallRemark = '-';
    if (rankable) {
        if (form === 'form1' || form === 'form2') {
            // NEW: use isStudentPass which checks A-D in >=6 subjects and English A-D
            const pass = isStudentPass(form, student);
            overallRemark = pass ? 'Pass' : 'Fail';
        } else {
            // For upper forms use existing pass rule
            const pass = isStudentPass(form, student);
            overallRemark = pass ? 'Pass' : 'Fail';
        }
    } else {
        overallRemark = '-';
    }

    // Compute average for lower forms
    const average = subjectsCount > 0 ? totalScore / subjectsCount : 0;

    return {
        totalScore: totalScore,
        average: average,
        aggregate: rankable ? aggregate : '-',
        subjectsCount: subjectsCount,
        rankable: rankable,
        overallRemark: overallRemark,
        overallMetric: overallMetric,
    };
}

function openSheetsPage() {
    goToPage('sheetsPage');
}

function openGradesPage() {
    goToPage('gradesPage');
    document.getElementById('gradesClassSelect').value = '';
    document.getElementById('gradesSheetTableWrapper').innerHTML = '';
}

function openAnalysisSelector() {
    goToPage('analysisSelectorPage');
}

function openDataEntryPage() {
    goToPage('dataEntryPage');
    const dataSubjectSelect = document.getElementById('dataSubjectSelect');
    dataSubjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
    ALL_SUBJECTS.forEach(subject => {
        dataSubjectSelect.innerHTML += `<option value="${subject}">${subject}</option>`;
    });
}

function openScoreSheetView() {
    goToPage('scoreSheetView');
    document.getElementById('sheetClassSelect').value = '';
    document.getElementById('scoreSheetTableWrapper').innerHTML = '';
}

function openAnalysisPage() {
    const form = document.getElementById('analysisClassSelect').value;
    if (!form) {
        alert('Please select a class for analysis.');
        return;
    }
    document.getElementById('analysisTitle').textContent = `${form.toUpperCase()} Class Analysis Report`;
    displayAnalysisSheet(form);
    goToPage('analysisPage');
}

async function loadStudentsForDataEntry() {
    const form = document.getElementById('dataClassSelect').value;
    const studentSelect = document.getElementById('dataStudentSelect');
    studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
    if (!form) return;
    const data = await fetchClassData(form);
    data.forEach(s => {
        studentSelect.innerHTML += `<option value="${s['Exam Number']}">${s['Exam Number']} - ${s["STUDENT'S NAME"]}</option>`;
    });
}

async function displayScoreSheet() {
    const form = document.getElementById('sheetClassSelect').value;
    const wrapper = document.getElementById('scoreSheetTableWrapper');
    wrapper.innerHTML = '';
    if (!form) return;
    const data = await fetchClassData(form);
    if (data.length === 0) {
        wrapper.innerHTML = '<p>No data available for this class.</p>';
        return;
    }

    const isLowerForm = form === 'form1' || form === 'form2';

    let html = '<table id="scoresTable"><thead><tr><th>Exam No</th><th>Name</th>';
    ALL_SUBJECTS.forEach(sub => { html += `<th>${getSubjectShortName(sub)}</th>`; });
    if (isLowerForm) {
        html += '<th>Total</th>';
    }
    html += '</tr></thead><tbody>';

    const studentsWithMetrics = [];
    for (const student of data) {
        const metrics = await calculateStudentMetrics(student, form);
        studentsWithMetrics.push({ student, metrics });
    }

    studentsWithMetrics.sort((a, b) => a.metrics.overallMetric - b.metrics.overallMetric);

    studentsWithMetrics.forEach(({ student, metrics }) => {
        let totalScore = 0;
        let rowHtml = `<tr><td>${student["Exam Number"]}</td><td>${student["STUDENT'S NAME"]}</td>`;

        ALL_SUBJECTS.forEach(sub => {
            const rawScore = student[sub] || '-';
            if (!isNaN(parseInt(rawScore)) && rawScore !== 'N' && rawScore !== 'X' && rawScore !== '-') {
                totalScore += parseInt(rawScore);
            }
            rowHtml += `<td>${rawScore}</td>`;
        });

        if (isLowerForm) {
            rowHtml += `<td>${totalScore}</td>`;
        }

        html += rowHtml;
    });

    html += '</tbody></table>';
    wrapper.innerHTML = html;
}

async function displayGradesSheet() {
    const form = document.getElementById('gradesClassSelect').value;
    const wrapper = document.getElementById('gradesSheetTableWrapper');
    wrapper.innerHTML = '';
    if (!form) return;
    const data = await fetchClassData(form);
    if (data.length === 0) {
        wrapper.innerHTML = '<p>No data available for this class.</p>';
        return;
    }

    const isUpperForm = form === 'form3' || form === 'form4';
    const finalColHeader = isUpperForm ? 'Aggregate' : 'Average';

    let html = `<table id="gradesTable"><thead><tr><th>POSITION</th><th>Exam No</th><th>Name</th>`;
    ALL_SUBJECTS.forEach(sub => { html += `<th>${getSubjectShortName(sub)}</th>`; });
    html += `<th>${finalColHeader}</th><th>Remark</th></tr></thead><tbody>`;

    const studentsWithMetrics = [];
    for (const student of data) {
        const metrics = await calculateStudentMetrics(student, form);
        studentsWithMetrics.push({ student, metrics, examNo: student["Exam Number"] });
    }

    // Only include rankable students for ranking computation
    let rankableStudents = studentsWithMetrics.filter(s => s.metrics.rankable);

    // Sort by overallMetric (ascending: lower aggregate is better)
    rankableStudents.sort((a, b) => a.metrics.overallMetric - b.metrics.overallMetric);
    const totalRankableStudents = rankableStudents.length;

    studentsWithMetrics.forEach(({ student, metrics, examNo }) => {
        let position = '-';
        if (metrics.rankable) {
             const studentMetric = rankableStudents.find(s => s.examNo === examNo);
             if (studentMetric) {
                const metricValue = studentMetric.metrics.overallMetric;
                // competition ranking: first index of this metricValue in sorted list + 1
                let actualRank = rankableStudents.findIndex(s => s.metrics.overallMetric === metricValue) + 1;
                position = `${actualRank}/${totalRankableStudents}`;
            }
        }

        let rowHtml = `<tr><td>${position}</td><td>${student["Exam Number"]}</td><td>${student["STUDENT'S NAME"]}</td>`;

        ALL_SUBJECTS.forEach(sub => {
            const rawScore = student[sub];
            let grade = '-';
            if (rawScore !== undefined && rawScore !== null && rawScore.toString().trim() !== '') {
                 if (rawScore.toUpperCase() === 'N' || rawScore.toUpperCase() === 'X' || rawScore === '-') {
                     grade = rawScore.toUpperCase() === '-' ? '-' : rawScore.toUpperCase();
                } else {
                    const numericScore = parseInt(rawScore);
                    if (!isNaN(numericScore)) {
                        const gr = getGradeAndRemark(form, rawScore);
                        grade = gr.grade;
                    } else {
                         grade = '-';
                    }
                }
            }
            rowHtml += `<td>${grade}</td>`;
        });
        
        const metricDisplay = isUpperForm
            ? (metrics.aggregate !== '-' ? metrics.aggregate : '-')
            : (metrics.average > 0 ? metrics.average.toFixed(1) : '-');

       rowHtml += `<td>${metricDisplay}</td><td>${metrics.overallRemark}</td></tr>`;
        html += rowHtml;
    });

    html += '</tbody></table>';
    wrapper.innerHTML = html;      
}

async function displayAnalysisSheet(form) {
    const wrapper = document.getElementById('analysisTableWrapper');
    wrapper.innerHTML = '';
    const data = await fetchClassData(form);
    if (data.length === 0) {
        wrapper.innerHTML = '<p>No data available for this class.</p>';
        return;
    }

    const isLowerForm = form === 'form1' || form === 'form2';
    const gradeKey = isLowerForm ? currentConfig.gradeKeyLower : currentConfig.gradeKeyUpper;
    const gradeLabels = Object.keys(gradeKey);

    gradeLabels.sort((a, b) => {
        if (isLowerForm) {
            return gradeKey[b] - gradeKey[a];
        } else {
            return parseInt(a) - parseInt(b);
        }
    });

    const subjectMetrics = {};
    ALL_SUBJECTS.forEach(sub => {
        subjectMetrics[sub] = {
            pass: 0,
            fail: 0,
            entries: 0,
            gradeCounts: Object.fromEntries(gradeLabels.map(l => [l, 0]))
        };
    });

    data.forEach(student => {
        ALL_SUBJECTS.forEach(sub => {
            const rawScore = student[sub];
            const numericScore = parseInt(rawScore);

            if (rawScore !== '-' && rawScore !== 'N' && rawScore !== 'X' && !isNaN(numericScore)) {
                const { grade, remark } = getGradeAndRemark(form, numericScore);
                subjectMetrics[sub].entries++;
                subjectMetrics[sub].gradeCounts[grade]++;

                if (remark.includes('Pass') || (isLowerForm && getGradeAndRemark(form, numericScore).grade.match(/[A-C]/))) {
                    subjectMetrics[sub].pass++;
                } else if (remark.includes('Fail') || (isLowerForm && getGradeAndRemark(form, numericScore).grade.match(/[D-F]/))) {
                    subjectMetrics[sub].fail++;
                }
            }
        });
    });

    let html = '<table id="analysisTable"><thead><tr><th>Subject</th>';
    gradeLabels.forEach(label => { html += `<th>${label}</th>`; });
    html += '<th>Pass %</th><th>Fail %</th><th>Entries</th></tr></thead><tbody>';

    const sortedSubjects = [...ALL_SUBJECTS].sort();

    sortedSubjects.forEach(sub => {
        const metrics = subjectMetrics[sub];
        if (metrics.entries > 0) {
            let rowHtml = `<tr><td>${sub}</td>`;

            gradeLabels.forEach(label => {
                rowHtml += `<td>${metrics.gradeCounts[label] || 0}</td>`;
            });

            const passPercent = ((metrics.pass / metrics.entries) * 100).toFixed(1);
            const failPercent = ((metrics.fail / metrics.entries) * 100).toFixed(1);

            rowHtml += `<td>${passPercent}%</td>`;
            rowHtml += `<td>${failPercent}%</td>`;
            rowHtml += `<td>${metrics.entries}</td></tr>`;
            html += rowHtml;
        } else {
             let rowHtml = `<tr><td>${sub}</td>`;
             gradeLabels.forEach(() => { rowHtml += `<td>0</td>`; });
             rowHtml += `<td>0.0%</td>`;
             rowHtml += `<td>0.0%</td>`;
             rowHtml += `<td>0</td></tr>`;
             html += rowHtml;
        }
    });

    html += '</tbody></table>';
    wrapper.innerHTML = html;
}

// --- NEW FUNCTIONS FOR PROGRESS SHEET SELECTION ---
async function openStudentProgressSheet() {
    const classSelect = document.getElementById('progressClassSelect').value;
    const examNumber = document.getElementById('progressExamNumber').value.trim().toUpperCase();

    if (!classSelect) {
        alert('Please select a class.');
        return;
    }
    if (!examNumber) {
        alert('Please enter an exam number.');
        return;
    }

    document.getElementById('selectedForm').value = classSelect;
    document.getElementById('studentNumberInput').value = examNumber;

    showLoading();
    try {
        lastCallingPage = 'sheetsPage';
        await loadResults(false);
        goToPage('progressReport');
    } catch (error) {
        console.error('Error loading student progress:', error);
        alert('Failed to load student progress. Please try again.');
    } finally {
        hideLoading();
    }
}

// --- INITIALIZATION ---
window.onload = function() {
    initializeConfig(null);

    const dataSubjectSelect = document.getElementById('dataSubjectSelect');
    if (dataSubjectSelect) {
        dataSubjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        ALL_SUBJECTS.forEach(subject => {
            dataSubjectSelect.innerHTML += `<option value="${subject}">${subject}</option>`;
        });
    }

    populateTeacherInputs();
};
</script>
</body>
</html>
